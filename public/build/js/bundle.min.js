function iniciarApp(){document.querySelector("#selectPeriodo")&&cargarResultados(),document.querySelector("#departamento")&&cargarDepartamentos(),document.querySelector("#modalConfirmacion")&&mostrarModal(),document.getElementById("progress_dashboard")&&loadProgress(),document.getElementById("filtro_resultados")&&filterResult(),document.getElementById("filtroEncuesta")&&filtroEncuestaClima(),document.getElementById("clave_depto")&&deptoClave(),function(){const e=document.getElementById("nombreDepartamento");e&&e.addEventListener("change",(function(){deptoClave(this)}))}(),document.getElementById("btnDescargar")&&setupDownloadButton()}function setupDownloadButton(){document.getElementById("btnDescargar").addEventListener("click",(function(){const e=document.createElement("a");e.href="https://miclima.mimundodigital.mx/Archivos/Plan%20de%20c,%20ac%20y%20m%20-%20Mundo%20Imperial.xlsx",e.download="Plan de c, ac y m - Mundo Imperial.xlsx",e.click()}))}function deptoClave(e){const t=e.options[e.selectedIndex].getAttribute("data-clave");document.getElementById("claveDepto").value=t}function mostrarModal(){const e=document.getElementById("modalConfirmacion"),t=e.querySelector(".close");document.querySelectorAll(".table__accion--eliminar").forEach(t=>{t.addEventListener("click",(function(t){t.preventDefault(),e.style.display="block";document.getElementById("confirmarEliminar").onclick=()=>{this.closest("form").submit()};document.getElementById("cancelarEliminar").onclick=()=>{e.style.display="none"}}))}),t&&t.addEventListener("click",(function(){e.style.display="none"}))}async function cargarResultados(){const e=document.getElementById("selectPeriodo"),t=document.getElementById("selectDepartamento"),n=document.getElementById("primer-encabezado"),o=document.getElementById("propiedadActual");async function a(){const a=e.value,d=t.value,s=o.value;if(a&&d)try{const e=`${location.origin}/resultados/api?periodos_id=${encodeURIComponent(a)}&departamentos_id=${encodeURIComponent(d)}&idpropiedades=${encodeURIComponent(s)}`,t=await fetch(e);!function(e,t){const o=document.querySelector(".table__tbody");if(o.innerHTML="",n.textContent=t?"Departamento":"Pregunta",t){Array.from(document.querySelectorAll("#departamentos-container span")).map(e=>(console.log(e.dataset),{claveDepto:e.dataset.clavedepto,periodos_id:e.dataset.periodos_id,nombreDepartamento:e.dataset.nombredepartamento})).forEach(t=>{const n=e.resultadosFiltrados.find(e=>e.departamentos_id.toString()===t.claveDepto)||{},a=e.resultadoPrevio.find(e=>e.departamentos_id.toString()===t.claveDepto)||{},d=Object.keys(n).length?l(n):"N/A",s="N/A"===a.departamentos_id?"N/A":Object.keys(a).length?l(a):"N/A",c="N/A"!==s&&"N/A"!==d?(parseFloat(d)-parseFloat(s)).toFixed(2):"N/A",u=document.createElement("tr");u.classList.add("table__tr"),u.innerHTML=`\n                    <td class="table__td-pregunta">${t.nombreDepartamento}</td>\n                    <td class="table__td ${r(d)}">${d}%</td>\n                    <td class="table__td ${i(c)}">${c}%</td>\n                    <td class="table__td ${r(s)}">${s}%</td>\n                `,o.appendChild(u)})}else{const t=Array.from(document.querySelectorAll("#preguntas-container span")).map(e=>e.dataset.pregunta),n=e.resultadosFiltrados.length>0?e.resultadosFiltrados[0]:null,a=e.resultadoPrevio||{},d=n?l(n):"N/A",s=a?l(a):"N/A",c="N/A"!==s?(parseFloat(d)-parseFloat(s)).toFixed(2):"N/A",u=document.createElement("tr");u.classList.add("table__tr"),u.innerHTML=`\n                <td class="table__td-pregunta"></td>\n                <td class="table__td ${r(d)}">${"N/A"!==d?d+"%":"N/A"}</td>\n                <td class="table__td ${i(c)}">${"N/A"!==c?c+"%":"N/A"}</td>\n                <td class="table__td ${r(s)}">${"N/A"!==s?s+"%":"N/A"}</td>\n            `,o.appendChild(u),t.forEach((e,t)=>{const l=n?parseFloat(n["cp"+(t+1)]):"N/A",d=a["cp"+(t+1)]?parseFloat(a["cp"+(t+1)]):"N/A",s="N/A"!==l&&"N/A"!==d?(l-d).toFixed(2):"N/A",c=document.createElement("tr");c.classList.add("table__tr"),c.innerHTML=`\n                    <td class="table__td-pregunta">${e}</td>\n                    <td class="table__td ${r(l)}">${"N/A"!==l?l+"%":"N/A"}</td>\n                    <td class="table__td ${i(s)}">${"N/A"!==s?s+"%":"N/A"}</td>\n                    <td class="table__td ${r(d)}">${"N/A"!==d?d+"%":"N/A"}</td>\n                `,o.appendChild(c)})}}(await t.json(),"RG"===d)}catch(e){console.error("Error al cargar los resultados:",e)}}function l(e){let t=0,n=0;for(let o=1;o<=16;o++){const a=parseFloat(e["cp"+o]);isNaN(a)||(t+=a,n++)}return n>0?(t/n).toFixed(2):"N/A"}function r(e){return e>=85?"calificacion-verde":e>=80?"calificacion-amarillo":"calificacion-rojo"}function i(e){if("N/A"===e||"0.00"===e)return"";return parseFloat(e)>0?"calificacion-verde":"calificacion-rojo"}e.addEventListener("change",a),t.addEventListener("change",a)}async function cargarDepartamentos(){try{const t=location.origin+"/encuesta/api",n=location.origin+"/encuesta/periodos",o=await fetch(t),a=await fetch(n),l=await o.json(),r=await a.json(),i=l.departamentos,d=(r.periodos,document.getElementById("propiedad")),s=document.getElementById("departamento"),c=document.getElementById("periodo");function e(){const e=d.value,t=c.value;if(s.innerHTML='<option value="">-- Seleccione --</option>',!e||!t)return;i.filter(n=>n.propiedades_id==e&&n.periodos_id==t).forEach(e=>{const t=document.createElement("option");t.value=e.claveDepto,t.textContent=e.nombreDepartamento,s.appendChild(t)})}d.addEventListener("change",e),e()}catch(e){console.error("Error al cargar datos:",e)}}function loadProgress(){document.querySelectorAll(".table__progreso").forEach((function(e){const t=e.getAttribute("data-porcentaje");e.style.width=t+"%"}))}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));const filterResult=async()=>{const e=document.getElementById("selectPeriodo"),t=document.getElementById("selectDepartamento"),n=document.getElementById("planAC"),o=document.getElementById("dep"),a=document.getElementById("per"),l=document.getElementById("depar"),r=document.getElementById("perio"),i=document.getElementById("dep1"),d=document.getElementById("per1"),s=document.getElementById("perpro"),c=(document.getElementById("perpro2"),document.getElementById("dashboardContenedor")),u=document.getElementById("dashboardContenedor1"),p=document.getElementById("preguntas-container"),m=document.getElementById("departamentos-container");let A,f;function v(){const n=e.value,o=t.value;if(!n)return p.style.display="none",void(m.style.display="none");"RG"===o?(!function(){const t=e.value;if(!t)return;m.innerHTML="";const n=f.filter(e=>e.periodos_id==t);n.sort((e,t)=>e.claveDepto<t.claveDepto?-1:e.claveDepto>t.claveDepto?1:0),n.forEach(e=>{const t=document.createElement("span");t.setAttribute("data-claveDepto",e.claveDepto),t.setAttribute("data-periodos_id",e.periodos_id),t.setAttribute("data-nombreDepartamento",e.nombreDepartamento),m.appendChild(t)}),m.style.display=n.length>0?"block":"none"}(),p.style.display="none"):""!==o?(!function(){const t=e.value;if(!t)return;p.innerHTML="";const n=A.filter(e=>e.idperiodo==t);n.forEach(e=>{const t=document.createElement("span");t.dataset.id=e.id,t.dataset.idpropiedades=e.idpropiedades,t.dataset.idperiodo=e.idperiodo,t.dataset.pregunta=e.pregunta,p.appendChild(t)}),p.style.display=n.length>0?"block":"none"}(),m.style.display="none"):(p.style.display="none",m.style.display="none")}function y(){const n=document.getElementById("tabla_resultados").getElementsByTagName("tbody")[0],c=t.value,u=e.value;o.value=c,l.value=c,i.value=c,a.value=u,r.value=u,d.value=u;const p=e.options[e.selectedIndex].getAttribute("data-propiedad");s.value=p,n.innerHTML=""}function g(){const n=e.value,o=t.value;if("RG"===o)return c.style.display="none",void(u.style.display="none");n&&o&&(!function(){const t=e.options[e.selectedIndex],n=t.value,o=t.dataset.propiedad,a=Array.from(e.options).filter(e=>e.dataset.propiedad===o),l=a[a.length-1];return l&&l.value===n}()?(c.style.display="none",u.style.display="block"):$.ajax({url:"/verificar-plan",method:"POST",data:{periodo:n,departamento:o},success:function(e){const t="string"==typeof e?JSON.parse(e):e;"NULL"===t.planAC||null===t.planAC||""===t.planAC?(c.style.display="block",u.style.display="none"):(c.style.display="none",u.style.display="block")},error:function(){console.error("Error al verificar PlanAC en la base de datos.")}}))}c.style.display="none",u.style.display="none",e.addEventListener("change",(async function(){await async function(){try{const e=await fetch(location.origin+"/resultados/index"),t=await e.json(),n=await fetch(location.origin+"/resultados/departamentos"),o=await n.json();A=t.preguntas,f=o.departamentos}catch(e){console.error("Error al cargar datos")}}(),function(){const n=e.value;t.innerHTML='<option selected value="">-- Departamento --</option>',n&&fetch("/obtenerdepto?periodos_id="+n).then(e=>e.json()).then(e=>{e.departamentos.sort((e,t)=>e.claveDepto<t.claveDepto?-1:e.claveDepto>t.claveDepto?1:0).forEach(e=>{const n=document.createElement("option");n.value=e.claveDepto,n.textContent=e.nombreDepartamento,t.appendChild(n)});const n=document.createElement("option");n.value="RG",n.textContent="Resultados Generales",t.appendChild(n)}).catch(e=>{console.error("Error al obtener los departamentos:",e)})}(),y(),c.style.display="none",u.style.display="none"})),t.addEventListener("change",(function(){!function(){const o=e.value,a=t.value;o&&a&&$.ajax({url:"/verificar-plan",method:"POST",data:{periodo:o,departamento:a},dataType:"json",success:function(e){null===e.planAC||""===e.planAC||"NULL"===e.planAC?n.value="NULL":n.value=e.planAC},error:function(){n.value="Error al obtener el PlanAC"}})}(),g(),y(),v()}));const h=document.querySelector("#btnExportar"),E=document.querySelector("#tabla_resultados");h.addEventListener("click",(function(){let e=new TableExport(E,{exportButtons:!1,filename:"Reporte MiClima",sheetname:"Reporte MiClima"}),t=e.getExportData().tabla_resultados.xlsx;e.export2file(t.data,t.mimeType,t.filename,t.fileExtension,t.merges,t.RTL,t.sheetname)}))};function filtroEncuestaClima(){!async function(){try{const e=location.origin+"/encuesta/preguntas",t=location.origin+"/encuesta/periodos",[n,o]=await Promise.all([fetch(e),fetch(t)]);if(!n.ok||!o.ok)throw new Error("Network response was not ok");const a=await n.json(),l=await o.json(),r=a.preguntas,i=l.periodos,d=document.getElementById("propiedad"),s=document.getElementById("periodo"),c=document.getElementById("propiedades"),u=document.getElementById("cuestionario");d.addEventListener("change",(function(){!function(e,t){const n=e.filter(e=>e.propiedades_id==t),o=n.reduce((e,t)=>new Date(t.periodo)>new Date(e.periodo)?t:e,n[0]);s.innerHTML=n.map(e=>`<option value="${e.id}">${e.id}</option>`).join(""),o?s.value=o.id:s.innerHTML='<option value="" disabled selected>No hay periodos disponibles</option>'}(i,d.value),s.dispatchEvent(new Event("change"))})),s.addEventListener("change",(function(){s.value?function(e,t,n){u.innerHTML="";const o=document.createElement("h3");o.textContent="Evaluación MI Clima Laboral "+(new Date).getFullYear(),u.appendChild(o);const a=e.filter(e=>e.idpropiedades===t&&e.idperiodo===n);a.forEach((e,t)=>{const n=document.createElement("div");n.classList.add("col");const o=document.createElement("p");o.classList.add("pregunta"),o.innerHTML=`<span>${e.idResultado}. </span>${e.pregunta}`,n.appendChild(o);const a=`\n                    <div class="form-check form-check-inline">\n                        <input class="form-check-input" type="radio" name="p${e.idResultado}" id="p${e.idResultado}-positivo" value="Positivo" required>\n                        <label class="form-check-label" for="p${e.idResultado}-positivo">Totalmente de acuerdo</label>\n                    </div>\n                    <div class="form-check form-check-inline">\n                        <input class="form-check-input" type="radio" name="p${e.idResultado}" id="p${e.idResultado}-positivo2" value="Positivo">\n                        <label class="form-check-label" for="p${e.idResultado}-positivo2">De acuerdo</label>\n                    </div>\n                    <div class="form-check form-check-inline">\n                        <input class="form-check-input" type="radio" name="p${e.idResultado}" id="p${e.idResultado}-neutro" value="Neutro">\n                        <label class="form-check-label" for="p${e.idResultado}-neutro">Ni en acuerdo, ni en desacuerdo</label>\n                    </div>\n                    <div class="form-check form-check-inline">\n                        <input class="form-check-input" type="radio" name="p${e.idResultado}" id="p${e.idResultado}-negativo" value="Negativo">\n                        <label class="form-check-label" for="p${e.idResultado}-negativo">En desacuerdo</label>\n                    </div>\n                    <div class="form-check form-check-inline">\n                        <input class="form-check-input" type="radio" name="p${e.idResultado}" id="p${e.idResultado}-negativo2" value="Negativo">\n                        <label class="form-check-label" for="p${e.idResultado}-negativo2">Totalmente en desacuerdo</label>\n                    </div>\n                `;n.innerHTML+=a,u.appendChild(n);n.querySelectorAll('input[type="radio"]').forEach(e=>{e.addEventListener("change",(function(){document.getElementById("p"+(t+1)).value=this.value}))})}),u.style.display=a.length>0?"block":"none"}(r,d.value,s.value):u.style.display="none"})),d.addEventListener("change",(function(){var e;e=d.value,c.value=e}))}catch(e){console.error("Error al cargar datos:",e)}}(),document.getElementById("formulario-encuesta").addEventListener("submit",(function(e){e.preventDefault();const t=document.querySelectorAll('#cuestionario input[type="radio"]');if(!Array.from(t).every(e=>{const t=e.name;return null!==document.querySelector(`input[name="${t}"]:checked`)}))return void alert("Por favor, responda todas las preguntas.");const n=new FormData(this);fetch("/encuesta",{method:"POST",body:n}).then(e=>{e.ok?(console.log("Datos enviados correctamente"),window.location.href="/respuestas-enviadas"):console.error("Error al enviar datos")}).catch(e=>{console.error("Error de red al enviar datos:",e)})}))}
/*! modernizr 3.6.0 (Custom Build) | MIT *
 * https://modernizr.com/download/?-webp-setclasses !*/!function(e,t,n){function o(e,t){return typeof e===t}function a(e){var t=u.className,n=s._config.classPrefix||"";if(p&&(t=t.baseVal),s._config.enableJSClass){var o=new RegExp("(^|\\s)"+n+"no-js(\\s|$)");t=t.replace(o,"$1"+n+"js$2")}s._config.enableClasses&&(t+=" "+n+e.join(" "+n),p?u.className.baseVal=t:u.className=t)}function l(e,t){if("object"==typeof e)for(var n in e)c(e,n)&&l(n,e[n]);else{var o=(e=e.toLowerCase()).split("."),r=s[o[0]];if(2==o.length&&(r=r[o[1]]),void 0!==r)return s;t="function"==typeof t?t():t,1==o.length?s[o[0]]=t:(!s[o[0]]||s[o[0]]instanceof Boolean||(s[o[0]]=new Boolean(s[o[0]])),s[o[0]][o[1]]=t),a([(t&&0!=t?"":"no-")+o.join("-")]),s._trigger(e,t)}return s}var r=[],i=[],d={_version:"3.6.0",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var n=this;setTimeout((function(){t(n[e])}),0)},addTest:function(e,t,n){i.push({name:e,fn:t,options:n})},addAsyncTest:function(e){i.push({name:null,fn:e})}},s=function(){};s.prototype=d,s=new s;var c,u=t.documentElement,p="svg"===u.nodeName.toLowerCase();!function(){var e={}.hasOwnProperty;c=o(e,"undefined")||o(e.call,"undefined")?function(e,t){return t in e&&o(e.constructor.prototype[t],"undefined")}:function(t,n){return e.call(t,n)}}(),d._l={},d.on=function(e,t){this._l[e]||(this._l[e]=[]),this._l[e].push(t),s.hasOwnProperty(e)&&setTimeout((function(){s._trigger(e,s[e])}),0)},d._trigger=function(e,t){if(this._l[e]){var n=this._l[e];setTimeout((function(){var e;for(e=0;e<n.length;e++)(0,n[e])(t)}),0),delete this._l[e]}},s._q.push((function(){d.addTest=l})),s.addAsyncTest((function(){function e(e,t,n){function o(t){var o=!(!t||"load"!==t.type)&&1==a.width;l(e,"webp"===e&&o?new Boolean(o):o),n&&n(t)}var a=new Image;a.onerror=o,a.onload=o,a.src=t}var t=[{uri:"data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=",name:"webp"},{uri:"data:image/webp;base64,UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAABBxAR/Q9ERP8DAABWUDggGAAAADABAJ0BKgEAAQADADQlpAADcAD++/1QAA==",name:"webp.alpha"},{uri:"data:image/webp;base64,UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA",name:"webp.animation"},{uri:"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=",name:"webp.lossless"}],n=t.shift();e(n.name,n.uri,(function(n){if(n&&"load"===n.type)for(var o=0;o<t.length;o++)e(t[o].name,t[o].uri)}))})),function(){var e,t,n,a,l,d;for(var c in i)if(i.hasOwnProperty(c)){if(e=[],(t=i[c]).name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(n=0;n<t.options.aliases.length;n++)e.push(t.options.aliases[n].toLowerCase());for(a=o(t.fn,"function")?t.fn():t.fn,l=0;l<e.length;l++)1===(d=e[l].split(".")).length?s[d[0]]=a:(!s[d[0]]||s[d[0]]instanceof Boolean||(s[d[0]]=new Boolean(s[d[0]])),s[d[0]][d[1]]=a),r.push((a?"":"no-")+d.join("-"))}}(),a(r),delete d.addTest,delete d.addAsyncTest;for(var m=0;m<s._q.length;m++)s._q[m]();e.Modernizr=s}(window,document);
//# sourceMappingURL=bundle.js.map
